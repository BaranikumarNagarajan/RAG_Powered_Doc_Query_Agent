<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>RAG Chatbot ‚Äî AI-DocQuery</title>
        <style>
            :root{
                --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03);
            }
            *{box-sizing:border-box}
            body{margin:0; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#071029 0%, #08182b 100%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px}
            .app{width:100%; max-width:1100px; display:grid; grid-template-columns:420px 1fr; gap:24px}
            .panel{background:linear-gradient(180deg,var(--card),#071025); border-radius:12px; padding:18px; box-shadow:0 6px 30px rgba(2,6,23,0.6);}

            /* Upload panel */
            .upload-area{border:2px dashed rgba(255,255,255,0.06); border-radius:10px; padding:18px; text-align:center; background:var(--glass)}
            .upload-area.dragover{border-color:var(--accent); box-shadow:0 8px 30px rgba(110,231,183,0.06)}
            .upload-area input{display:none}
            .btn{display:inline-flex; align-items:center; gap:8px; background:linear-gradient(90deg,var(--accent), #56c5a3); color:#022; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; border:none}
            .muted{color:var(--muted); font-size:13px}

            /* Chat panel */
            .chat-wrap{display:flex; flex-direction:column; height:70vh}
            .messages{flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:12px;}
            .msg{max-width:85%; padding:12px 14px; border-radius:12px; line-height:1.4}
            .msg.user{align-self:flex-end; background:linear-gradient(90deg,#1e3a8a,#3b82f6); color:white; border-bottom-right-radius:4px}
            .msg.bot{align-self:flex-start; background:rgba(255,255,255,0.03); color:var(--muted); border-bottom-left-radius:4px}
            .msg .source-list{margin-top:8px; font-size:12px; color:var(--muted)}

            .composer{display:flex; gap:8px; margin-top:12px}
            .composer input[type=text]{flex:1; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
            .small{font-size:13px}

            footer{margin-top:12px; color:var(--muted); font-size:13px; text-align:center}

            @media (max-width:900px){.app{grid-template-columns:1fr;}
                .chat-wrap{height:60vh}}
        </style>
    </head>
    <body>
        <div class="app">
            <div class="panel">
                <h2 style="margin:0 0 8px">üìÅ Upload document</h2>
                <div id="uploadArea" class="upload-area">
                    <p style="margin:6px 0 12px"><strong class="small">Drag & drop</strong> a PDF / DOCX / TXT file here or click to choose</p>
                    <label class="btn" for="fileInput">Choose file</label>
                    <input id="fileInput" type="file" accept=".pdf,.docx,.txt" />
                    <div id="uploadInfo" class="muted" style="margin-top:12px">No file selected</div>
                    <div style="margin-top:14px">
                        <button id="uploadBtn" class="btn" style="background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--accent)" onclick="uploadFile()">Upload to index</button>
                    </div>
                    <div id="uploadStatus" class="muted small" style="margin-top:10px"></div>
                </div>

                <hr style="border:none; height:1px; background:rgba(255,255,255,0.03); margin:16px 0">

                <div>
                    <h3 style="margin:0 0 8px">Instructions</h3>
                    <p class="muted small" style="margin:0">Upload documents to add them to the vector store. After upload, ask questions in the chat panel. Point IDs are autogenerated UUIDs; filenames are stored as sources.</p>
                </div>
            </div>

            <div class="panel chat-wrap">
                <div style="display:flex; align-items:center; justify-content:space-between">
                    <h2 style="margin:0">üí¨ Chat & Query</h2>
                    <div class="muted small">Qdrant & Embeddings</div>
                </div>

                <div id="messages" class="messages" aria-live="polite"></div>

                <div class="composer">
                    <input id="question" type="text" placeholder="Ask something about your uploaded documents..."/>
                    <button class="btn" onclick="askQuestion()">Ask</button>
                </div>

                <footer>Sources will be shown under the answer (when available)</footer>
            </div>
        </div>

        <script>
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadInfo = document.getElementById('uploadInfo');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');
            const messages = document.getElementById('messages');

            // Drag & drop handlers
            ['dragenter','dragover'].forEach(evt => uploadArea.addEventListener(evt, e => { e.preventDefault(); uploadArea.classList.add('dragover'); }));
            ['dragleave','drop'].forEach(evt => uploadArea.addEventListener(evt, e => { e.preventDefault(); uploadArea.classList.remove('dragover'); }));
            uploadArea.addEventListener('drop', e => {
                const f = e.dataTransfer.files[0];
                if (f) { fileInput.files = e.dataTransfer.files; onFileSelected(); }
            });

            fileInput.addEventListener('change', onFileSelected);
            function onFileSelected(){
                const f = fileInput.files[0];
                uploadInfo.textContent = f ? `${f.name} ‚Äî ${Math.round(f.size/1024)} KB` : 'No file selected';
                uploadStatus.textContent = '';
            }

            async function uploadFile(){
                const f = fileInput.files[0];
                if(!f) return alert('Please select a file to upload');
                uploadStatus.textContent = 'Uploading...';
                uploadBtn.disabled = true;
                try{
                    const fd = new FormData(); fd.append('file', f);
                    const res = await fetch('/upload', { method: 'POST', body: fd });
                    const data = await res.json();
                    if(res.ok){
                        uploadStatus.textContent = `Uploaded ‚Äî ${data.chunks_uploaded || data.chunks || data.message || 'done'}`;
                    }else{
                        uploadStatus.textContent = `Upload failed: ${data.message || JSON.stringify(data)}`;
                    }
                }catch(err){
                    uploadStatus.textContent = 'Upload error: ' + err.message;
                }finally{ uploadBtn.disabled = false }
            }

            function appendMessage(text, who='bot', sources=null){
                const node = document.createElement('div');
                node.className = 'msg ' + (who==='user' ? 'user' : 'bot');
                node.innerHTML = `<div>${escapeHtml(text).replace(/\n/g,'<br/>')}</div>`;
                if(sources && sources.length){
                    const srcList = document.createElement('div'); srcList.className = 'source-list';
                    srcList.innerHTML = '<strong>Sources:</strong> ' + sources.map(s=>escapeHtml(s.filename||'')).join(', ');
                    node.appendChild(srcList);
                }
                messages.appendChild(node);
                messages.scrollTop = messages.scrollHeight;
            }

                    function escapeHtml(str){
                        if(!str) return '';
                        const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
                        return String(str).replace(/[&<>"']/g, function(m){ return map[m]; });
                    }

            async function askQuestion(){
                const qEl = document.getElementById('question');
                const question = qEl.value.trim();
                if(!question) return alert('Type a question first');
                appendMessage(question, 'user');
                qEl.value = '';
                appendMessage('Thinking...', 'bot');
                try{
                    const res = await fetch('/query', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ question }) });
                    const data = await res.json();
                    // Remove the 'Thinking...' message (last bot)
                    const botNodes = Array.from(messages.querySelectorAll('.msg.bot'));
                    if(botNodes.length) botNodes[botNodes.length-1].remove();

                    if(res.ok){
                        appendMessage(data.answer || JSON.stringify(data), 'bot', data.sources || []);
                    }else{
                        appendMessage('Error: ' + (data.error || JSON.stringify(data)), 'bot');
                    }
                }catch(err){
                    appendMessage('Network error: ' + err.message, 'bot');
                }
            }

            // Small UX: allow Enter to send question
            document.getElementById('question').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ askQuestion(); } });

            // initial
            onFileSelected();
        </script>
    </body>
</html>
